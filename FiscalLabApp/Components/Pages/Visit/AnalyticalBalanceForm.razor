@page "/visits/{visitId}/analytical-balance"
@implements IDisposable
@implements IAsyncDisposable
@using FiscalLabApp.Extensions
@layout EditVisitLayout

@inject IMenuService MenuService

<VisitDataSeparator Title="Balança Analítica">
    <div class="row">
        <div class="col">
            <VisitTextInput Title="Peso Homogenio Apos" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceHomogeneousWeight)" Id="homogeneousWeight" @bind-value="AnalyticalBalance.HomogeneousWeight"/>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <VisitTextInput Title="Peso Amostra Final" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceFinalWeight)" Id="finalWeight" @bind-value="AnalyticalBalance.FinalWeight"/>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <VisitTextInput Title="Balança Aferida" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceCalibratedBalance)" Id="calibratedBalance" @bind-value="AnalyticalBalance.CalibratedBalance"/>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <VisitTextInput Title="Balança Nivelada" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceLeveledBalance)" Id="leveledBalance" @bind-value="AnalyticalBalance.LeveledBalance"/>
        </div>
    </div>
    
    <div class="row">
            <div class="col">
                <VisitTextInput Title="Balança Com Certificado de Calibragem" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceCalibrationCertificateBalance)" Id="calibrationCertificateBalance" @bind-value="AnalyticalBalance.CalibrationCertificateBalance"/>
            </div>
        </div>
    
    <div class="row">
            <div class="col">
                <VisitTextInput Title="Observações 5" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceObservations5)" Id="observations5" @bind-value="AnalyticalBalance.Observations5"/>
            </div>
        </div>
</VisitDataSeparator>


<VisitDataSeparator Title="Temperatura Ambiente">
    <div class="row">
        <div class="col">
            <VisitTextInput Title="Média temperatura ambiente(20ºC±3)" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceAverageAmbientTemperature)" Id="averageAmbientTemperature" @bind-value="AnalyticalBalance.AverageAmbientTemperature"/>
        </div>
    </div>
    
    <div class="row">
        <div class="col">
            <VisitTextInput Title="Observações 6" Menu="@_options.GetMenu(MenuType.AnalyticalBalanceObservations6)" Id="observations6" @bind-value="AnalyticalBalance.Observations6"/>
        </div>
    </div>
</VisitDataSeparator>

@code {

    [CascadingParameter]
    public EditVisitLayout Layout { get; set; } = new();
    [Parameter] public string? VisitId { get; set; }
    private Menu[] _options = Array.Empty<Menu>();
    
    public AnalyticalBalanceViewModel AnalyticalBalance { get; set; } = new();
    
    protected override async Task OnInitializedAsync()
    {
        _options = await MenuService.GetMenuOptions(PageType.AnalyticalBalance);
    }
    
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        if (VisitId is null) return;
        AnalyticalBalance = (await Layout.SyncVisit(VisitId)).AnalyticalBalance;
    }
    
    public void Dispose()
    { 
        UpdateVisit();
    }
    
    public async ValueTask DisposeAsync()
    {
        await UpdateVisit();
    }

    private async Task UpdateVisit()
    {
        await Layout.UpdateVisitAsync();
    }
}
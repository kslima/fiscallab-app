@page "/visits/{visitId}/system-consistency"
@implements IDisposable
@implements IAsyncDisposable
@using FiscalLabApp.Enums
@using FiscalLabApp.Extensions
@using FiscalLabApp.Helpers
@using FiscalLabApp.Services
@layout EditVisitLayout
@inject IMenuService MenuService
@inject SelectedPageEventNotifier SelectedPageEventNotifier

<VisitDataSeparator Title="Amostra">
    <div class="row">
        <div class="col">
            <VisitTextInput Title="O.C" Id="pressureGaugeCertificated" Menu="@_options.GetMenu(MenuType.SystemConsistencyOc)" @bind-value="SystemConsistency.Oc"/>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <VisitTextInput Title="Fazenda" Id="systemConsistencyFarm" Menu="@_options.GetMenu(MenuType.SystemConsistencyFarm)" @bind-value="SystemConsistency.Farm"/>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <VisitTextInput Title="Propietário" Id="systemConsistencyOwner" Menu="@_options.GetMenu(MenuType.SystemConsistencyOwner)" @bind-value="SystemConsistency.Owner"/>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <VisitTextInput Title="Observações" Id="systemConsistencyObservations" Menu="@_options.GetMenu(MenuType.SystemConsistencyObservations)" @bind-value="SystemConsistency.Observations"/>
        </div>
    </div>
</VisitDataSeparator>

<VisitDataSeparator Title="Dados Para Cálculo ATR">
    <div class="row">
        <div class="col">
            <InputSelect @bind-Value="SystemConsistency.Clarifier" class="form-select form-select-lg mb-3" @oninput="OnClarifierSelected">
                @foreach (var clarify in Enum.GetValues(typeof(Clarify)))
                {
                    <option value="@clarify">@clarify</option>
                }
            </InputSelect>
        </div>
    </div>
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Pbu" Id="benchmarkingEquipmentExpectedCrop" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Pbu" ValueUpdated="CalculateAtr"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Brix" Id="benchmarkingEquipmentAccomplishedCrop" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Brix" ValueUpdated="CalculateAtr"/>
        </div>
        <VisitNumberInput Title="LS" Id="benchmarkingEquipmentPreviousCrop" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Ls" ValueUpdated="CalculateAtr"/>
    </div>
</VisitDataSeparator>

<VisitDataSeparator Title="Atr">
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Usina" Id="cystemConsistencyPlantAtr" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Atr" Readonly="true" ValueUpdated="CalculateAtrDifference"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Consecana" Id="systemConsistencyConsecanaAtr" @bind-value="SystemConsistency.ConsecanaSugarcaneAnalysis.Atr" ValueUpdated="CalculateAtrDifference"/>
        </div>
        <VisitNumberInput Title="Variação" Id="systemConsistencyDifferenceAtr" @bind-value="SystemConsistency.DifferenceAtr" Readonly="true"/>
    </div>

</VisitDataSeparator>

<VisitDataSeparator Title="Pureza">
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Usina" Id="cystemConsistencyPlantPurity" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Purity" Readonly="true" ValueUpdated="CalculatePurityDifference"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Consecana" Id="systemConsistencyConsecanaPurity" @bind-value="SystemConsistency.ConsecanaSugarcaneAnalysis.Purity" ValueUpdated="CalculatePurityDifference"/>
        </div>
        <VisitNumberInput Title="Variação" Id="systemConsistencyDifferencePurity" @bind-value="SystemConsistency.DifferencePurity" Readonly="true"/>
    </div>
</VisitDataSeparator>

<VisitDataSeparator Title="Pol">
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Usina" Id="cystemConsistencyPlantPol" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Pol" Readonly="true" ValueUpdated="CalculatePolDifference"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Consecana" Id="systemConsistencyConsecanaPol" @bind-value="SystemConsistency.ConsecanaSugarcaneAnalysis.Pol" ValueUpdated="CalculatePolDifference"/>
        </div>
        <VisitNumberInput Title="Variação" Id="systemConsistencyDifferencePol" @bind-value="SystemConsistency.DifferencePol" Readonly="true"/>
    </div>
</VisitDataSeparator>

<VisitDataSeparator Title="Fibra">
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Usina" Id="cystemConsistencyPlantFiber" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Fiber" Readonly="true" ValueUpdated="CalculateFiberDifference"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Consecana" Id="systemConsistencyConsecanaFiber" @bind-value="SystemConsistency.ConsecanaSugarcaneAnalysis.Fiber" ValueUpdated="CalculateFiberDifference"/>
        </div>
        <VisitNumberInput Title="Variação" Id="systemConsistencyDifferenceFiber" @bind-value="SystemConsistency.DifferenceFiber" Readonly="true"/>
    </div>

</VisitDataSeparator>

<VisitDataSeparator Title="Pcc">
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Usina" Id="systemConsistencyPlantPcc" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Pcc" Readonly="true" ValueUpdated="CalculatePccDifference"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Consecana" Id="systemConsistencyConsecanaPcc" @bind-value="SystemConsistency.ConsecanaSugarcaneAnalysis.Pcc" ValueUpdated="CalculatePccDifference"/>
        </div>
        <VisitNumberInput Title="Pcc()" Id="systemConsistencyDifferencePcc" @bind-value="SystemConsistency.DifferencePcc" Readonly="true"/>
    </div>
</VisitDataSeparator>

<VisitDataSeparator Title="Ar">
    <div class="d-flex">
        <div class="me-1">
            <VisitNumberInput Title="Usina" Id="cystemConsistencyPlantAr" @bind-value="SystemConsistency.PlantSugarcaneAnalysis.Ar" Readonly="true" ValueUpdated="CalculateArDifference"/>
        </div>
        <div class="me-1">
            <VisitNumberInput Title="Consecana" Id="systemConsistencyConsecanaAr" @bind-value="SystemConsistency.ConsecanaSugarcaneAnalysis.Ar" ValueUpdated="CalculateArDifference"/>
        </div>
        <VisitNumberInput Title="Variação" Id="systemConsistencyDifferenceAr" @bind-value="SystemConsistency.DifferenceAr" Readonly="true"/>
    </div>
</VisitDataSeparator>

@code {

    [CascadingParameter] public EditVisitLayout Layout { get; set; } = new();
    [Parameter] public string? VisitId { get; set; }
    private Visit? _selectedVisit;
    private Menu[] _options = Array.Empty<Menu>();
    public SystemConsistencyViewModel SystemConsistency { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _options = await MenuService.GetMenuOptions(PageType.SystemConsistency);
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if (VisitId is null) return;
        SystemConsistency = (await Layout.SyncVisit(VisitId)).SystemConsistency;
        SelectedPageEventNotifier.Notify(PageHelper.SystemConsistencyPageName);
    }

    public void Dispose()
    {
        UpdateVisit();
    }

    public async ValueTask DisposeAsync()
    {
        await UpdateVisit();
    }

    private async Task UpdateVisit()
    {
        await Layout.UpdateVisitAsync();
    }

    private void OnClarifierSelected(ChangeEventArgs e)
    {
        if (e.Value is null) return;

        if (!Enum.TryParse<Clarify>(e.Value.ToString(), out var clarify)) return;
        SystemConsistency.Clarifier = clarify;
        CalculateAtr();
        CalculateAtrDifference();
        CalculatePurityDifference();
        CalculatePolDifference();
        CalculateFiberDifference();
        CalculatePccDifference();
        CalculateArDifference();
    }

    private void CalculateAtr()
    {
        if (SystemConsistency.Clarifier is null ||
            SystemConsistency.PlantSugarcaneAnalysis.Pbu == 0 ||
            SystemConsistency.PlantSugarcaneAnalysis.Brix == 0 ||
            SystemConsistency.PlantSugarcaneAnalysis.Ls == 0) return;

        var sugarcaneAnalysis = new SugarcaneAnalysisViewModel(
            SystemConsistency.Clarifier.Value,
            SystemConsistency.PlantSugarcaneAnalysis.Pbu,
            SystemConsistency.PlantSugarcaneAnalysis.Brix,
            SystemConsistency.PlantSugarcaneAnalysis.Ls);

        SystemConsistency.PlantSugarcaneAnalysis.Atr = sugarcaneAnalysis.Atr.RoundToEven(3);
        SystemConsistency.PlantSugarcaneAnalysis.Purity = sugarcaneAnalysis.Purity.RoundToEven(3);
        SystemConsistency.PlantSugarcaneAnalysis.Pol = sugarcaneAnalysis.Pol.RoundToEven(3);
        SystemConsistency.PlantSugarcaneAnalysis.Fiber = sugarcaneAnalysis.Fiber.RoundToEven(3);
        SystemConsistency.PlantSugarcaneAnalysis.Pcc = sugarcaneAnalysis.Pcc.RoundToEven(3);
        SystemConsistency.PlantSugarcaneAnalysis.Ar = sugarcaneAnalysis.Ar.RoundToEven(3);
    }

    private void CalculateAtrDifference()
    {
        SystemConsistency.DifferenceAtr = SystemConsistency.PlantSugarcaneAnalysis.Atr - SystemConsistency.ConsecanaSugarcaneAnalysis.Atr;
    }

    private void CalculatePurityDifference()
    {
        SystemConsistency.DifferencePurity = SystemConsistency.PlantSugarcaneAnalysis.Purity - SystemConsistency.ConsecanaSugarcaneAnalysis.Purity;
    }

    private void CalculatePolDifference()
    {
        SystemConsistency.DifferencePol = SystemConsistency.PlantSugarcaneAnalysis.Pol - SystemConsistency.ConsecanaSugarcaneAnalysis.Pol;
    }

    private void CalculateFiberDifference()
    {
        SystemConsistency.DifferenceFiber = SystemConsistency.PlantSugarcaneAnalysis.Fiber - SystemConsistency.ConsecanaSugarcaneAnalysis.Fiber;
    }

    private void CalculatePccDifference()
    {
        SystemConsistency.DifferencePcc = SystemConsistency.PlantSugarcaneAnalysis.Pcc - SystemConsistency.ConsecanaSugarcaneAnalysis.Pcc;
    }

    private void CalculateArDifference()
    {
        SystemConsistency.DifferenceAr = SystemConsistency.PlantSugarcaneAnalysis.Ar - SystemConsistency.ConsecanaSugarcaneAnalysis.Ar;
    }

}